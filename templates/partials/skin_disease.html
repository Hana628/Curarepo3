<div class="skin-disease-container">
    <form id="skin-disease-form" class="mb-4">
        <p class="mb-3">Upload a clear image of the affected skin area for analysis:</p>
        
        <div class="mb-4">
            <div class="upload-container">
                <div class="image-preview-container p-3 text-center border rounded mb-3">
                    <div id="image-preview" class="mb-3">
                        <i class="fas fa-camera fa-4x text-muted"></i>
                        <p class="text-muted">Image preview will appear here</p>
                    </div>
                    <label for="skin-image" class="btn btn-outline-primary">
                        <i class="fas fa-upload me-2"></i>Choose Image
                    </label>
                    <input type="file" id="skin-image" accept="image/*" class="d-none">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="form-floating">
                    <select id="skin-location" class="form-select">
                        <option value="" selected disabled>Select location</option>
                        <option value="face">Face</option>
                        <option value="scalp">Scalp</option>
                        <option value="neck">Neck</option>
                        <option value="chest">Chest</option>
                        <option value="back">Back</option>
                        <option value="arm">Arm</option>
                        <option value="hand">Hand</option>
                        <option value="leg">Leg</option>
                        <option value="foot">Foot</option>
                        <option value="abdomen">Abdomen</option>
                        <option value="groin">Groin</option>
                        <option value="buttocks">Buttocks</option>
                    </select>
                    <label for="skin-location">Location on body</label>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-floating">
                    <select id="skin-duration" class="form-select">
                        <option value="" selected disabled>Select duration</option>
                        <option value="hours">Few hours</option>
                        <option value="days">Few days</option>
                        <option value="week">About a week</option>
                        <option value="weeks">Few weeks</option>
                        <option value="month">About a month</option>
                        <option value="months">Few months</option>
                        <option value="year">About a year</option>
                        <option value="years">Several years</option>
                    </select>
                    <label for="skin-duration">How long have you had it?</label>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <p class="mb-2">Additional symptoms (select all that apply):</p>
            <div class="symptom-checkboxes">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="itching" id="symptom-itching">
                            <label class="form-check-label" for="symptom-itching">Itching</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="pain" id="symptom-pain">
                            <label class="form-check-label" for="symptom-pain">Pain</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="burning" id="symptom-burning">
                            <label class="form-check-label" for="symptom-burning">Burning sensation</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="swelling" id="symptom-swelling">
                            <label class="form-check-label" for="symptom-swelling">Swelling</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="bleeding" id="symptom-bleeding">
                            <label class="form-check-label" for="symptom-bleeding">Bleeding</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="spreading" id="symptom-spreading">
                            <label class="form-check-label" for="symptom-spreading">Spreading to other areas</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary mt-3">
            <i class="fas fa-camera me-2"></i>Analyze Skin Condition
        </button>
    </form>
    
    <div id="skin-disease-results" class="mt-4 d-none">
        <div class="alert alert-info">
            <div class="d-flex">
                <div class="me-3">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
                <div>
                    <h5 class="alert-heading">Analyzing your image...</h5>
                    <p class="mb-0">Please wait while we process your skin image.</p>
                </div>
            </div>
        </div>
        
        <div class="prediction-card d-none">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Skin Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-4 mb-md-0">
                            <div id="analyzed-image-container" class="mb-3">
                                <img id="analyzed-image" class="img-fluid rounded border" alt="Analyzed skin image">
                            </div>
                            <div class="text-center">
                                <span class="badge bg-info" id="confidence-badge">Confidence: 85%</span>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h4 id="predicted-skin-disease" class="mb-3">Condition Name</h4>
                            <p id="skin-disease-description" class="mb-4">Description will appear here.</p>
                            
                            <h5 class="mb-3">Care Recommendations</h5>
                            <ul id="skin-care-recommendations" class="list-group mb-4">
                                <!-- Care recommendations will appear here -->
                            </ul>
                            
                            <div class="specialist-recommendation mt-4 border-top pt-3">
                                <h5 class="mb-3">Recommended Specialist</h5>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-light me-3">
                                        <i class="fas fa-user-md text-primary"></i>
                                    </div>
                                    <div>
                                        <h6 id="skin-specialist-type" class="mb-1">Dermatologist</h6>
                                        <p class="text-muted small mb-0">Based on the analysis, we recommend consulting with this specialist.</p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <a href="#appointments-section" class="btn btn-outline-primary btn-sm" id="book-skin-specialist">
                                        <i class="fas fa-calendar-plus me-2"></i>Book Appointment
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <p class="text-muted small mb-0">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        This is an AI-assisted analysis and should not replace professional medical advice. Please consult with a healthcare provider.
                    </p>
                </div>
            </div>
            
            <button type="button" class="btn btn-outline-secondary" id="reset-skin-disease">
                <i class="fas fa-redo me-2"></i>Analyze Another Image
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        setupSkinDiseaseDetection();
    });
    
    function setupSkinDiseaseDetection() {
        const form = document.getElementById('skin-disease-form');
        const resultsContainer = document.getElementById('skin-disease-results');
        const resetBtn = document.getElementById('reset-skin-disease');
        const imageUpload = document.getElementById('skin-image');
        const imagePreview = document.getElementById('image-preview');
        const bookSpecialistBtn = document.getElementById('book-skin-specialist');
        
        let uploadedImage = null;
        
        // Handle image upload and preview
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check if file is an image
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }
            
            // Check file size (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should not exceed 5MB');
                return;
            }
            
            // Create a preview
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = e.target.result;
                imagePreview.innerHTML = `<img src="${uploadedImage}" class="img-fluid rounded" style="max-height: 200px;">`;
                
                // Also set the analyzed image for results
                document.getElementById('analyzed-image').src = uploadedImage;
            };
            reader.readAsDataURL(file);
        });
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!uploadedImage) {
                alert('Please upload an image of the affected skin area');
                return;
            }
            
            // Get selected symptoms
            const selectedSymptoms = [];
            document.querySelectorAll('.symptom-checkboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedSymptoms.push(checkbox.value);
            });
            
            // Get location and duration
            const location = document.getElementById('skin-location').value;
            const duration = document.getElementById('skin-duration').value;
            
            // Show loading state
            resultsContainer.classList.remove('d-none');
            resultsContainer.querySelector('.prediction-card').classList.add('d-none');
            
            // Make API request
            fetch('/predict/skin_disease', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_data: uploadedImage,
                    location: location,
                    duration: duration,
                    symptoms: selectedSymptoms
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displaySkinResults(data.prediction);
                } else {
                    throw new Error(data.message || 'Error analyzing skin image');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${error.message || 'An error occurred during analysis. Please try again.'}
                    </div>
                `;
            });
        });
        
        // Display prediction results
        function displaySkinResults(prediction) {
            // Hide loading, show results
            resultsContainer.querySelector('.alert').classList.add('d-none');
            const predictionCard = resultsContainer.querySelector('.prediction-card');
            predictionCard.classList.remove('d-none');
            
            // Update UI with prediction data
            document.getElementById('predicted-skin-disease').textContent = prediction.disease;
            
            // If there's a confidence value
            if (prediction.confidence) {
                document.getElementById('confidence-badge').textContent = `Confidence: ${prediction.confidence}%`;
                document.getElementById('confidence-badge').classList.remove('d-none');
            } else {
                document.getElementById('confidence-badge').classList.add('d-none');
            }
            
            // Set description
            document.getElementById('skin-disease-description').textContent = prediction.description;
            
            // Set specialist type
            document.getElementById('skin-specialist-type').textContent = prediction.specialist;
            
            // Update care recommendations
            const recommendationsList = document.getElementById('skin-care-recommendations');
            recommendationsList.innerHTML = '';
            
            prediction.care_recommendations.forEach(recommendation => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-start';
                li.innerHTML = `
                    <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                    <span>${recommendation}</span>
                `;
                recommendationsList.appendChild(li);
            });
            
            // Set up the book appointment button to pre-fill the specialist
            bookSpecialistBtn.addEventListener('click', function() {
                // Show the appointments section
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('d-none');
                });
                document.getElementById('appointments-section').classList.remove('d-none');
                
                // Pre-select the specialist in the dropdown if possible
                const specialistSelect = document.getElementById('specialist');
                if (specialistSelect) {
                    // Set to dermatologist by default for skin issues
                    for (let i = 0; i < specialistSelect.options.length; i++) {
                        if (specialistSelect.options[i].value === 'derma') {
                            specialistSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // Set the reason for visit if the textarea exists
                const reasonTextarea = document.getElementById('reason');
                if (reasonTextarea) {
                    reasonTextarea.value = `Consultation regarding potential ${prediction.disease} diagnosis`;
                }
                
                // Update sidebar to show appointments tab as active
                const sidebarLinks = document.querySelectorAll('.sidebar-link');
                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#appointments-section') {
                        link.classList.add('active');
                    }
                });
            });
        }
        
        // Reset the form
        resetBtn.addEventListener('click', function() {
            form.reset();
            uploadedImage = null;
            imagePreview.innerHTML = '<i class="fas fa-camera fa-4x text-muted"></i><p class="text-muted">Image preview will appear here</p>';
            resultsContainer.classList.add('d-none');
        });
    }
</script>